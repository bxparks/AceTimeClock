<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AceTimeClock: ace_time::clock::Stm32F1Clock Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AceTimeClock
   &#160;<span id="projectnumber">1.2.3</span>
   </div>
   <div id="projectbrief">Clock classes for Arduino that can synchronize from an NTP server or an RTC chip</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><b>ace_time</b></li><li class="navelem"><b>clock</b></li><li class="navelem"><a class="el" href="classace__time_1_1clock_1_1Stm32F1Clock.html">Stm32F1Clock</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="classace__time_1_1clock_1_1Stm32F1Clock-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">ace_time::clock::Stm32F1Clock Class Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>An implementation of <code><a class="el" href="classace__time_1_1clock_1_1Clock.html" title="Abstract base class for objects that provide and store time.">Clock</a></code> that is specialized for the LSE_CLOCK (Low Speed External clock) on the STM32F1 RTC chip.  
 <a href="classace__time_1_1clock_1_1Stm32F1Clock.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="Stm32F1Clock_8h_source.html">Stm32F1Clock.h</a>&gt;</code></p>
<div class="dynheader">
Inheritance diagram for ace_time::clock::Stm32F1Clock:</div>
<div class="dyncontent">
<div class="center"><img src="classace__time_1_1clock_1_1Stm32F1Clock__inherit__graph.png" border="0" usemap="#aace__time_1_1clock_1_1Stm32F1Clock_inherit__map" alt="Inheritance graph"/></div>
<map name="aace__time_1_1clock_1_1Stm32F1Clock_inherit__map" id="aace__time_1_1clock_1_1Stm32F1Clock_inherit__map">
<area shape="rect" title="An implementation of Clock that is specialized for the LSE_CLOCK (Low Speed External clock) on the ST..." alt="" coords="5,80,196,121"/>
<area shape="rect" href="classace__time_1_1clock_1_1Clock.html" title="Abstract base class for objects that provide and store time." alt="" coords="17,5,185,32"/>
</map>
<center><span class="legend">[<a href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for ace_time::clock::Stm32F1Clock:</div>
<div class="dyncontent">
<div class="center"><img src="classace__time_1_1clock_1_1Stm32F1Clock__coll__graph.png" border="0" usemap="#aace__time_1_1clock_1_1Stm32F1Clock_coll__map" alt="Collaboration graph"/></div>
<map name="aace__time_1_1clock_1_1Stm32F1Clock_coll__map" id="aace__time_1_1clock_1_1Stm32F1Clock_coll__map">
<area shape="rect" title="An implementation of Clock that is specialized for the LSE_CLOCK (Low Speed External clock) on the ST..." alt="" coords="5,80,196,121"/>
<area shape="rect" href="classace__time_1_1clock_1_1Clock.html" title="Abstract base class for objects that provide and store time." alt="" coords="17,5,185,32"/>
</map>
<center><span class="legend">[<a href="graph_legend.html">legend</a>]</span></center></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a25ea1875f56aa617e5a25cac2312b5c5"><td class="memItemLeft" align="right" valign="top"><a id="a25ea1875f56aa617e5a25cac2312b5c5"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classace__time_1_1clock_1_1Stm32F1Clock.html#a25ea1875f56aa617e5a25cac2312b5c5">setup</a> ()</td></tr>
<tr class="memdesc:a25ea1875f56aa617e5a25cac2312b5c5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configure the clock. <br /></td></tr>
<tr class="separator:a25ea1875f56aa617e5a25cac2312b5c5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6f544153491c504cb0225376c6ad58f1"><td class="memItemLeft" align="right" valign="top">acetime_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classace__time_1_1clock_1_1Stm32F1Clock.html#a6f544153491c504cb0225376c6ad58f1">getNow</a> () const override</td></tr>
<tr class="memdesc:a6f544153491c504cb0225376c6ad58f1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return the number of seconds since the AceTime epoch (2000-01-01T00:00:00Z).  <a href="classace__time_1_1clock_1_1Stm32F1Clock.html#a6f544153491c504cb0225376c6ad58f1">More...</a><br /></td></tr>
<tr class="separator:a6f544153491c504cb0225376c6ad58f1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7aa4e4480772fa6698215131c1880459"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classace__time_1_1clock_1_1Stm32F1Clock.html#a7aa4e4480772fa6698215131c1880459">setNow</a> (acetime_t epochSeconds) override</td></tr>
<tr class="memdesc:a7aa4e4480772fa6698215131c1880459"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the time to the indicated seconds.  <a href="classace__time_1_1clock_1_1Stm32F1Clock.html#a7aa4e4480772fa6698215131c1880459">More...</a><br /></td></tr>
<tr class="separator:a7aa4e4480772fa6698215131c1880459"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="inherit_header pub_methods_classace__time_1_1clock_1_1Clock"><td colspan="2" onclick="javascript:toggleInherit('pub_methods_classace__time_1_1clock_1_1Clock')"><img src="closed.png" alt="-"/>&#160;Public Member Functions inherited from <a class="el" href="classace__time_1_1clock_1_1Clock.html">ace_time::clock::Clock</a></td></tr>
<tr class="memitem:a7f80c56a13701aba06aa086325cccbc5 inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="memItemLeft" align="right" valign="top"><a id="a7f80c56a13701aba06aa086325cccbc5"></a>
&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classace__time_1_1clock_1_1Clock.html#a7f80c56a13701aba06aa086325cccbc5">Clock</a> ()=default</td></tr>
<tr class="memdesc:a7f80c56a13701aba06aa086325cccbc5 inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="mdescLeft">&#160;</td><td class="mdescRight">Default constructor. <br /></td></tr>
<tr class="separator:a7f80c56a13701aba06aa086325cccbc5 inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad0d9d27352a1d8d09221f2f15bc0f9c4 inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classace__time_1_1clock_1_1Clock.html#ad0d9d27352a1d8d09221f2f15bc0f9c4">~Clock</a> ()=default</td></tr>
<tr class="memdesc:ad0d9d27352a1d8d09221f2f15bc0f9c4 inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="mdescLeft">&#160;</td><td class="mdescRight">We deliberately avoid using a virtual destructor.  <a href="classace__time_1_1clock_1_1Clock.html#ad0d9d27352a1d8d09221f2f15bc0f9c4">More...</a><br /></td></tr>
<tr class="separator:ad0d9d27352a1d8d09221f2f15bc0f9c4 inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a789be177b3a48408fca1805a90d7e34e inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="memItemLeft" align="right" valign="top"><a id="a789be177b3a48408fca1805a90d7e34e"></a>
virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classace__time_1_1clock_1_1Clock.html#a789be177b3a48408fca1805a90d7e34e">sendRequest</a> () const</td></tr>
<tr class="memdesc:a789be177b3a48408fca1805a90d7e34e inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="mdescLeft">&#160;</td><td class="mdescRight">Send a time request asynchronously. <br /></td></tr>
<tr class="separator:a789be177b3a48408fca1805a90d7e34e inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ada1474de64fd88ca8466bea08165b3c3 inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="memItemLeft" align="right" valign="top"><a id="ada1474de64fd88ca8466bea08165b3c3"></a>
virtual bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classace__time_1_1clock_1_1Clock.html#ada1474de64fd88ca8466bea08165b3c3">isResponseReady</a> () const</td></tr>
<tr class="memdesc:ada1474de64fd88ca8466bea08165b3c3 inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return true if a response is ready. <br /></td></tr>
<tr class="separator:ada1474de64fd88ca8466bea08165b3c3 inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acb014777a376ad582151486b64db67fc inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="memItemLeft" align="right" valign="top">virtual acetime_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classace__time_1_1clock_1_1Clock.html#acb014777a376ad582151486b64db67fc">readResponse</a> () const</td></tr>
<tr class="memdesc:acb014777a376ad582151486b64db67fc inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="mdescLeft">&#160;</td><td class="mdescRight">Returns number of seconds since AceTime epoch (2000-01-01).  <a href="classace__time_1_1clock_1_1Clock.html#acb014777a376ad582151486b64db67fc">More...</a><br /></td></tr>
<tr class="separator:acb014777a376ad582151486b64db67fc inherit pub_methods_classace__time_1_1clock_1_1Clock"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="inherited"></a>
Additional Inherited Members</h2></td></tr>
<tr class="inherit_header pub_static_attribs_classace__time_1_1clock_1_1Clock"><td colspan="2" onclick="javascript:toggleInherit('pub_static_attribs_classace__time_1_1clock_1_1Clock')"><img src="closed.png" alt="-"/>&#160;Static Public Attributes inherited from <a class="el" href="classace__time_1_1clock_1_1Clock.html">ace_time::clock::Clock</a></td></tr>
<tr class="memitem:ae4fb852c09fbb9e37cc5764787dbf094 inherit pub_static_attribs_classace__time_1_1clock_1_1Clock"><td class="memItemLeft" align="right" valign="top"><a id="ae4fb852c09fbb9e37cc5764787dbf094"></a>
static const acetime_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classace__time_1_1clock_1_1Clock.html#ae4fb852c09fbb9e37cc5764787dbf094">kInvalidSeconds</a> = LocalTime::kInvalidSeconds</td></tr>
<tr class="memdesc:ae4fb852c09fbb9e37cc5764787dbf094 inherit pub_static_attribs_classace__time_1_1clock_1_1Clock"><td class="mdescLeft">&#160;</td><td class="mdescRight">Error value returned by <a class="el" href="classace__time_1_1clock_1_1Clock.html#a018eaa1936dd0750eb2098e1c6ada9e4" title="Return the number of seconds since the AceTime epoch (2000-01-01T00:00:00Z).">getNow()</a> and other methods when this object is not yet initialized. <br /></td></tr>
<tr class="separator:ae4fb852c09fbb9e37cc5764787dbf094 inherit pub_static_attribs_classace__time_1_1clock_1_1Clock"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>An implementation of <code><a class="el" href="classace__time_1_1clock_1_1Clock.html" title="Abstract base class for objects that provide and store time.">Clock</a></code> that is specialized for the LSE_CLOCK (Low Speed External clock) on the STM32F1 RTC chip. </p>
<p>Normally, the LSE_CLOCK requires an additional external 32.768 kHz crystal, but the popular "Blue Pill" dev board already includes this extenal crystal on pins C14 and C15. <b>Warning</b>: For the highest clock accuracy, those pins should not be attached anything else, not even the male header pins. The header pins will add too much stray capacitance to the oscillator circuit, and cause the clock to run too slow. I have seen the clock run as much as 10% too slow with the male header pins attached. If you hold a finger to those pins, it adds so much capacitance that the LSE_CLOCK will appear to just stop.</p>
<p>There are 3 possible RTC clocks on the STM32F1 (HSI_CLOCK, LSI_CLOCK, and LSE_CLOCK). But the LSE_CLOCK is special because it keeps updating the RTC on the STM32F1 through a reset or power loss, as long as a battery is attached to VBat. The battery could be a 3V CR2032 coin battery, or 2AA rechargeable or non-rechargeable battery, or it could be a super capacitor.</p>
<p>This class uses the <code>Stm32F1Rtc</code> helper class to write directly to the RTC registers on the STM32F1, bypassing the generic <code>STM32RTC</code> library (<a href="https://github.com/stm32duino/STM32RTC">https://github.com/stm32duino/STM32RTC</a>) which would normally be used for other STM32 microcontrollers. The generic <code>STM32RTC</code> library has a bug on the STM32F1 where it preserves only the time fields in the RTC registers, saving the date fields on SRAM which is lost upon reset (See <a href="https://github.com/stm32duino/STM32RTC/issues/29">https://github.com/stm32duino/STM32RTC/issues/29</a> and <a href="https://github.com/stm32duino/STM32RTC/issues/32">https://github.com/stm32duino/STM32RTC/issues/32</a>). The problem is caused in the low-level HAL (hardware abstraction layer) of the STM32F1 chip, because unlike other STM32 processors which stores the time and date fields as separate fields, the RTC on the STM32F1 is just a simple 32-bit counter (split across 2 registeres, RTC_CNTH and RTC_CNTL) that increments once a second.</p>
<p>It turns out that for the purposes of AceTime and the <code>SystemClock</code>, a 32-bit counter is sufficient to support all of its functionality. In particular, the 32-bit counter is sufficient to allow AceTime to retain both date and time fields through a power reset. So the <code>Stm32F1Rtc</code> class is a narrowly targeted HAL whose only purpose is to read from and write to the 32-bit RTC counter on the STM32F1 chip. It bypasses the entire generic RTC and HAL layers provided by the STM32duino framework.</p>
<p>AceTime v2 allows the epoch year of the library to be adjustable by the client application, from the year 2000 until the year 10000. The use of a simple 32-bit counter in the STM32F1 works to its advantage because it makes it allows it work for any the epoch year selected in the AceTime library. This is in contrast to the other STM32 processors which use a 2-digit year offset from the year 2000. The RTC of those processors will break in the year 2100 unless a software fix can be created to work around that limitation.</p>
<p>The <code>Stm32F1Rtc</code> class uses one additional register, the Backup DR1 register, which holds a single status bit to indicate whether or not the underlying RTC counter has been initialized to a valid time. The selection of the <code>DR1</code> register, instead of any of the other 9-10 backup registers, is currently hardcoded in the <code>RTC_INIT_REG</code> macro in <code><a class="el" href="Stm32F1Rtc_8h_source.html">Stm32F1Rtc.h</a></code>. If that causes a conflict with something else, let me know, because this is fixable. We can make that a configurable parameter in the Stm32F1Rtc::begin() method. </p>

<p class="definition">Definition at line <a class="el" href="Stm32F1Clock_8h_source.html#l00077">77</a> of file <a class="el" href="Stm32F1Clock_8h_source.html">Stm32F1Clock.h</a>.</p>
</div><h2 class="groupheader">Member Function Documentation</h2>
<a id="a6f544153491c504cb0225376c6ad58f1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6f544153491c504cb0225376c6ad58f1">&#9670;&nbsp;</a></span>getNow()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">acetime_t ace_time::clock::Stm32F1Clock::getNow </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">override</span><span class="mlabel">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Return the number of seconds since the AceTime epoch (2000-01-01T00:00:00Z). </p>
<p>Returns kInvalidSeconds if an error has occured.</p>
<p>This is a blocking call. Some clocks (e.g. NTP client) this may take many seconds. On those clocks, use the asynchronous methods (<a class="el" href="classace__time_1_1clock_1_1Clock.html#a789be177b3a48408fca1805a90d7e34e" title="Send a time request asynchronously.">sendRequest()</a>, <a class="el" href="classace__time_1_1clock_1_1Clock.html#ada1474de64fd88ca8466bea08165b3c3" title="Return true if a response is ready.">isResponseReady()</a>, and <a class="el" href="classace__time_1_1clock_1_1Clock.html#acb014777a376ad582151486b64db67fc" title="Returns number of seconds since AceTime epoch (2000-01-01).">readResponse()</a>) instead. </p>

<p>Implements <a class="el" href="classace__time_1_1clock_1_1Clock.html#a018eaa1936dd0750eb2098e1c6ada9e4">ace_time::clock::Clock</a>.</p>

<p class="definition">Definition at line <a class="el" href="Stm32F1Clock_8h_source.html#l00088">88</a> of file <a class="el" href="Stm32F1Clock_8h_source.html">Stm32F1Clock.h</a>.</p>

</div>
</div>
<a id="a7aa4e4480772fa6698215131c1880459"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7aa4e4480772fa6698215131c1880459">&#9670;&nbsp;</a></span>setNow()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void ace_time::clock::Stm32F1Clock::setNow </td>
          <td>(</td>
          <td class="paramtype">acetime_t&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">override</span><span class="mlabel">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Set the time to the indicated seconds. </p>
<p>Calling with a value of kInvalidSeconds indicates an error condition, so the method should do nothing. Some clocks do not support this feature, for example, NTP or GPS clocks and this method will be a no-op. </p>

<p>Reimplemented from <a class="el" href="classace__time_1_1clock_1_1Clock.html#a958ab88f7ba9893c557038e1424138ca">ace_time::clock::Clock</a>.</p>

<p class="definition">Definition at line <a class="el" href="Stm32F1Clock_8h_source.html#l00096">96</a> of file <a class="el" href="Stm32F1Clock_8h_source.html">Stm32F1Clock.h</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>/home/brian/src/AceTimeClock/src/ace_time/clock/<a class="el" href="Stm32F1Clock_8h_source.html">Stm32F1Clock.h</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
